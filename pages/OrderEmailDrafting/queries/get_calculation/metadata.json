{
  "pluginType": "DB",
  "pluginId": "postgres-plugin",
  "unpublishedAction": {
    "name": "get_calculation",
    "datasource": {
      "name": "Logistics_db",
      "pluginId": "postgres-plugin",
      "messages": [],
      "isAutoGenerated": false,
      "id": "Logistics_db",
      "deleted": false,
      "policies": [],
      "userPermissions": []
    },
    "pageId": "OrderEmailDrafting",
    "actionConfiguration": {
      "timeoutInMillisecond": 10000,
      "paginationType": "NONE",
      "encodeParamsToggle": true,
      "body": "\n\nWITH RECURSIVE item_tree(\"Id\", \"SubItemID\", \"InvoiceID\", \"Qty\", \"InitialProdDescription\", \"Amount\", \"PrinterPriceID\", \"Rate\", \"Printer\", depth, \"Destination\") AS (\n  SELECT \"Id\", \"SubItemID\", \"InvoiceID\", \"Qty\", \"InitialProdDescription\", \"Amount\", \"PrinterPriceID\", \"Rate\", \"Printer\", 0, \"Destination\"\n  FROM \"public\".\"PrinterLineItems\"\n  WHERE \"SubItemID\" IS NULL\n  UNION ALL\n  SELECT oi.\"Id\", oi.\"SubItemID\", oi.\"InvoiceID\", oi.\"Qty\", oi.\"InitialProdDescription\", oi.\"Amount\", oi.\"PrinterPriceID\", oi.\"Rate\", oi.\"Printer\", depth + 1, oi.\"Destination\"\n  FROM \"public\".\"PrinterLineItems\" oi\n  JOIN item_tree t ON oi.\"SubItemID\" = t.\"Id\"\n),\nitemsubitems AS (\n  SELECT * FROM item_tree tt\n  WHERE \"Id\" = {{}} OR \"SubItemID\" =  {{a}}\n  ORDER BY COALESCE(tt.\"SubItemID\", tt.\"Id\"), tt.\"Id\"\n)\nSELECT \n  CASE \n  WHEN COUNT(*) <=2 AND EXISTS (SELECT 1 FROM itemsubitems WHERE \"InitialProdDescription\" LIKE '%Envelope%') THEN (\n      SELECT \"Qty\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n    ) || ' * (' || (\n      SELECT \"Rate\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n    )  || '' || (\n      SELECT '' FROM itemsubitems WHERE \"InitialProdDescription\" LIKE '%Envelope%'  \n    )|| ') = ' || (\n      SELECT SUM(\"Amount\") FROM itemsubitems\n    )\n    WHEN COUNT(*) <=3 THEN (\n      SELECT \"Qty\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n    ) || ' * (' || (\n      SELECT \"Rate\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n    ) || ' + (' || (\n      SELECT \"Rate\" FROM itemsubitems WHERE \"InitialProdDescription\" LIKE '%Extra%' OR \"InitialProdDescription\" LIKE '%add%' LIMIT 1\n    ) || ' * ' || (\n      ((SELECT \"Qty\" FROM itemsubitems WHERE \"InitialProdDescription\" LIKE '%Extra%' OR \"InitialProdDescription\" LIKE '%add%' LIMIT 1) / (SELECT \"Qty\" FROM itemsubitems WHERE \"SubItemID\" IS NULL))\n    )|| ')) = ' || (\n      SELECT SUM(\"Amount\") FROM itemsubitems\n    )\n    ELSE (\n      SELECT \"Qty\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n    ) || ' * (' || (\n      SELECT \"Rate\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n    ) || ' + (' || (\n      SELECT \"Rate\" FROM itemsubitems WHERE \"InitialProdDescription\" LIKE '%Extra%' OR \"InitialProdDescription\" LIKE '%add%' LIMIT 1\n    ) || ' * ' || (\n      ((SELECT \"Qty\" FROM itemsubitems WHERE \"InitialProdDescription\" LIKE '%Extra%' OR \"InitialProdDescription\" LIKE '%add%' LIMIT 1) / (SELECT \"Qty\" FROM itemsubitems WHERE \"SubItemID\" IS NULL))\n    ) || ')' || (\n      SELECT STRING_AGG(' + ' || \"Rate\", '') FROM itemsubitems WHERE \"InitialProdDescription\" NOT LIKE '%Extra%' AND \"InitialProdDescription\" NOT LIKE '%add%' AND \"InitialProdDescription\" NOT LIKE '%Envelope%' AND \"Rate\" IS NOT NULL AND \"SubItemID\" IS NOT NULL\n    ) || ') = ' || (\n      SELECT SUM(\"Amount\") FROM itemsubitems\n    )\n  END AS formula \nFROM itemsubitems;\n\n\n\n\n\n\n\n",
      "selfReferencingDataPaths": [],
      "pluginSpecifiedTemplates": [
        {
          "value": false
        }
      ]
    },
    "executeOnLoad": false,
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "isValid": true,
    "invalids": [],
    "messages": [],
    "jsonPathKeys": [
      "",
      "a"
    ],
    "userSetOnLoad": false,
    "confirmBeforeExecute": false,
    "policies": [],
    "userPermissions": []
  },
  "id": "OrderEmailDrafting_get_calculation",
  "deleted": false,
  "gitSyncId": "63b393c7f276cd0745e9510c_6474d2f7b577966223c74724"
}