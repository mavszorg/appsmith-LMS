{
  "pluginType": "DB",
  "pluginId": "postgres-plugin",
  "unpublishedAction": {
    "name": "get_draftorders",
    "datasource": {
      "name": "Logistics_db",
      "pluginId": "postgres-plugin",
      "messages": [],
      "isAutoGenerated": false,
      "id": "Logistics_db",
      "deleted": false,
      "policies": [],
      "userPermissions": []
    },
    "pageId": "OrderEmailDrafting",
    "actionConfiguration": {
      "timeoutInMillisecond": 10000,
      "paginationType": "NONE",
      "encodeParamsToggle": true,
      "body": "WITH customer_line_items_query AS (\n  SELECT\n    c1.\"CustomerName\",\n    c3.\"Id\",\n    c3.\"InvoiceID\",\n    c3.\"CustomerPriceID\",\n    c3.\"Qty\",\n    c3.\"Rate\",\n    c3.\"Amount\",\n    c3.\"SubItemID\",\n    c3.\"Printer\",\n    c3.\"OrderStatus\",\n    c3.\"Notes\",\n    c3.\"Destination\",\n    i.\"InvoiceDate\",\n    i.\"PaymentMethod\",\n    i.\"InvoiceStatus\",\n    i.\"OrderStatus\" AS \"InvoiceOrderStatus\"\n  FROM\n    \"public\".\"Customers\" c1\n    INNER JOIN \"public\".\"CustomerPrice\" c2 ON (c2.\"CustomerID\" = c1.\"Id\")\n    INNER JOIN \"public\".\"CustomerLineItems\" c3 ON (c3.\"CustomerPriceID\" = c2.\"Id\")\n    INNER JOIN \"public\".\"Invoice\" i ON (i.\"InvoiceID\" = c3.\"InvoiceID\")\n  WHERE\n    EXISTS (\n      SELECT p.\"ProductDescription\"\n      FROM \"public\".\"Products\" p\n      WHERE p.\"Id\" = c2.\"ProductID\"\n    )\n    AND \"SubItemID\" IS NULL\n    AND to_date(cast(i.\"InvoiceDate\" as TEXT), 'YYYY-MM-DD') >= '{{moment(DatePicker1.selectedDate).format('YYYY-MM-DD')}}'\n    AND to_date(cast(i.\"InvoiceDate\" as TEXT), 'YYYY-MM-DD') <= '{{moment(DatePicker1.selectedDate).format('YYYY-MM-DD')}}'\n),\ncategory_tree_query AS (\n  WITH RECURSIVE category_tree AS (\n    SELECT\n      \"Id\",\n      \"SubItemID\",\n      \"InvoiceID\",\n      \"Qty\",\n      \"CustomerPriceID\",\n      \"Amount\",\n      \"Printer\",\n      \"Destination\"\n    FROM\n      \"CustomerLineItems\"\n    WHERE\n      \"SubItemID\" IS NULL -- start with top-level categories\n    UNION ALL\n    SELECT\n      oi.\"Id\",\n      oi.\"SubItemID\",\n      oi.\"InvoiceID\",\n      oi.\"Qty\",\n      oi.\"CustomerPriceID\",\n      oi.\"Amount\",\n      oi.\"Printer\",\n      oi.\"Destination\"\n    FROM\n      \"CustomerLineItems\" oi\n      JOIN category_tree ct ON oi.\"SubItemID\" = ct.\"Id\"\n  ),\n  total_amount AS (\n    SELECT SUM(\"Amount\") AS total FROM category_tree\n  )\n  SELECT\n    COALESCE(it.\"SubItemID\", it.\"Id\") AS \"Id\",\n    string_agg(p.\"ProductDescription\", ' ➤ ') AS \"OrderDetails\",\n    SUM(it.\"Amount\") AS \"Summary\"\n  FROM\n    category_tree it\n    JOIN \"public\".\"CustomerPrice\" c2 ON (it.\"CustomerPriceID\" = c2.\"Id\")\n    JOIN \"public\".\"Products\" p ON (p.\"Id\" = c2.\"ProductID\")\n  GROUP BY\n    COALESCE(it.\"SubItemID\", it.\"Id\")\n  ORDER BY\n    \"OrderDetails\" ASC\n),\nfiltered_category_tree_query AS (\n  SELECT *\n  FROM category_tree_query\n  -- WHERE \"OrderDetails\" LIKE '%BW SS - First Class%'\n),\nprinter_line_items_query AS (\n  SELECT\n    main_items.\"Id\" AS \"Id\",\n    CONCAT_WS(' ➤ ', main_items.\"InitialProdDescription\", string_agg(sub_items.\"InitialProdDescription\", ' ➤ ')) AS \"OrderDetailsPrinter\",\n    COALESCE(main_items.\"Amount\", 0) + COALESCE(sub_items_total.\"Amount\", 0) AS \"PSummary\"\nFROM\n\"PrinterLineItems\" AS main_items\nLEFT JOIN (\nSELECT \"SubItemID\", SUM(\"Amount\") AS \"Amount\"\nFROM \"PrinterLineItems\"\nWHERE \"SubItemID\" IS NOT NULL\nGROUP BY \"SubItemID\"\n) sub_items_total ON main_items.\"Id\" = sub_items_total.\"SubItemID\"\nLEFT JOIN (\nSELECT \"SubItemID\", SUM(\"Amount\") AS \"Amount\", \"InitialProdDescription\"\nFROM \"PrinterLineItems\"\nWHERE \"SubItemID\" IS NOT NULL\nGROUP BY \"SubItemID\", \"InitialProdDescription\"\n) sub_items ON main_items.\"Id\" = sub_items.\"SubItemID\"\nINNER JOIN \"public\".\"Invoice\" i ON i.\"InvoiceID\" = main_items.\"InvoiceID\"\nINNER JOIN \"Customers\" c1 ON (c1.\"Id\" = i.\"CustomerID\")\nINNER JOIN \"PrinterPrice\" p1 ON (p1.\"Id\" = main_items.\"PrinterPriceID\")\nINNER JOIN \"Products\" p2 ON (p2.\"Id\" = p1.\"ProductID\")\nWHERE\nmain_items.\"SubItemID\" IS NULL\nGROUP BY\nmain_items.\"Id\",\nmain_items.\"InitialProdDescription\",\nsub_items_total.\"Amount\"\nORDER BY\nmain_items.\"Id\" ASC\n),\ngrouped_query AS (\nSELECT\nCASE\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Glory%' THEN 'BW DS - FC Generic - Credit Glory Inc'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Credit Sage LLC%' THEN 'BW DS - FC Generic - Credit Sage LLC Inc'\nWHEN customer_line_items_query.\"CustomerName\" LIKE '%ECA GreenTech%' THEN 'ECA Greentech'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Certified Mail RR%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Certified Mail RR - BW SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Certified Mail RR%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Certified Mail RR - BW DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Certified Mail RR%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Certified Mail RR - CLR SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Certified Mail RR%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Certified Mail RR - CLR DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Certified Mail NRR%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Certified Mail NRR - BW SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Certified Mail NRR%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Certified Mail NRR - BW DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Certified Mail NRR%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Certified Mail NRR - CLR SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Certified Mail NRR%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Certified Mail NRR - CLR DS'\nWHEN customer_line_items_query.\"CustomerName\"  LIKE '%swyftconnect%'  THEN 'swyftconnect Return Envelope'\nWHEN customer_line_items_query.\"CustomerName\"  LIKE '%Highland%'  THEN 'Highland Health Direct FFW Custom Envelope'\t\nWHEN customer_line_items_query.\"CustomerName\"  LIKE '%Titanvest%'  THEN 'Titanvest Return Envelope'\nWHEN customer_line_items_query.\"CustomerName\"  LIKE '%Octopus Energy%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%#9 Envelope%'  THEN 'Octopus Energy Return Envelope'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%#9 Envelope%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Return Envelope - CLR SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%#9 Envelope%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Return Envelope - CLR DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%#10 Envelope%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Custom Envelope - BW SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%#10 Envelope%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Custom Envelope - BW DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%#10 Envelope%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Custom Envelope - CLR SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%#10 Envelope%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Custom Envelope - CLR DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%SameDay%'  AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%Cheque add''l Sheet%' THEN 'SameDay Cheques w/ Docs'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%SameDay%'  AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%Cheque Only%' THEN 'SameDay Cheques Only'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%International Delivery%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%' THEN 'International Delivery - BW SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%International Delivery%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%' THEN 'International Delivery - BW DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%International Delivery%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%' THEN 'International Delivery - CLR SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%International Delivery%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%' THEN 'International Delivery - CLR DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%International Delivery%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%Postcard 4x6%' THEN 'International Delivery -Postcard 4x6'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%International Delivery%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%Postcard 6x9%' THEN 'International Delivery -Postcard 6x9'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%International Delivery%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%Postcard 6x11%' THEN 'International Delivery -Postcard 6x11'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%USPS%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Priority/Express - BW SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%USPS%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Priority/Express - BW DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%USPS%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Priority/Express - CLR SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%USPS%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Priority/Express - CLR DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%USPS%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Priority/Express - BW SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%USPS%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Priority/Express - BW DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%USPS%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Priority/Express - CLR SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%USPS%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Priority/Express- CLR DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%UPS CA Express%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Priority/Express - BW SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%UPS CA Express%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Priority/Express - BW DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%UPS CA Express%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Priority/Express - CLR SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%UPS CA Express%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Priority/Express - CLR DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%UPS CA Express%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Priority/Express - BW SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%UPS CA Express%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Priority/Express - BW DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%UPS CA Express%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Priority/Express - CLR SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%UPS CA Express%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Priority/Express- CLR DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Perforated%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Perforated - BW SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Perforated%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Perforated - BW DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%UPerforated%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Perforated - CLR SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Perforated%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Perforated - CLR DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Perforated%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Perforated - BW SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Perforated%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Perforated - BW DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Perforated%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Perforated - CLR SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Perforated%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Perforated- CLR DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Registered Mail%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Registered Mail - BW SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Registered Mail%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Registered Mail - BW DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Registered Mail%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Registered Mail - CLR SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Registered Mail%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Registered Mail - CLR DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Registered Mail%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW SS%'  THEN 'Registered Mail - BW SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Registered Mail%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%BW DS%'  THEN 'Registered Mail - BW DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Registered Mail%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR SS%'  THEN 'Registered Mail - CLR SS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Registered Mail%' AND filtered_category_tree_query.\"OrderDetails\"  LIKE '%CLR DS%'  THEN 'Registered Mail - CLR DS'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Cheque add''l Sheet%' THEN 'Letter Size - Cheques with Documents'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - Cheque Only%' THEN 'Letter Size - Cheques Only'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%A4 Size - Cheque Only%' THEN 'A4 Size - Cheques Only'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%First Class%'  AND  filtered_category_tree_query.\"OrderDetails\" LIKE '%4x6 Lamination%' THEN 'Postcard 4x6 Lamination - First Class'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%First Class%'  AND  filtered_category_tree_query.\"OrderDetails\" LIKE '%6x9 Lamination%' THEN 'Postcard 6x9 Lamination - First Class'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%First Class%'  AND  filtered_category_tree_query.\"OrderDetails\" LIKE '%6x11 Lamination%' THEN 'Postcard 6x11 Lamination - First Class'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Standard Class%'  AND  filtered_category_tree_query.\"OrderDetails\" LIKE '%4x6 Lamination%' THEN 'Postcard 4x6 Lamination - Standard Class'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Standard Class%'  AND  filtered_category_tree_query.\"OrderDetails\" LIKE '%6x9 Lamination%' THEN 'Postcard6x9 Lamination - Standard Class'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Standard Class%'  AND  filtered_category_tree_query.\"OrderDetails\" LIKE '%6x11 Lamination%' THEN 'Postcard 6x11 Lamination - Standard Class'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 4x6 - First Class%' THEN 'Postcard 4x6 - First Class'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x9 - First Class%' THEN 'Postcard 6x9 - First Class'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x11 - First Class%' THEN 'Postcard 6x11 - First Class'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 4x6 - Standard Class%' THEN 'Postcard 4x6 - Standard Class'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x9 - Standard Class%' THEN 'Postcard 6x9 - Standard Class'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x11 - Standard Class%' THEN 'Postcard 6x11 - Standard Class'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 4x6 - Lettermail%' THEN 'Postcard 4x6 - Lettermail'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x9 - Lettermail%' THEN 'Postcard 6x9 - Lettermail'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x11 - Lettermail%' THEN 'Postcard 6x11 - Lettermail'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 4x6 - Personalized%' THEN 'Postcard 4x6 - Personalized'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x9 - Personalized%' THEN 'Postcard 6x9 - Personalized'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x11 - Personalized%' THEN 'Postcard 6x11 - Personalized'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 4x6 - Second Class%' THEN 'Postcard 4x6 - Second Class'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x9 - Second Class%' THEN 'Postcard 6x9 - Second Class'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Postcard 6x11 - Second Class%' THEN 'Postcard 6x11 - Second Class'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - BW SS - First Class%' THEN 'Letter Size - BW SS - FC Generic'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - BW DS - First Class%' THEN 'Letter Size - BW DS - FC Generic'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - CLR SS - First Class%' THEN 'Letter Size - CLR SS - FC Generic'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - CLR DS - First Class%' THEN 'Letter Size - CLR DS - FC Generic'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - BW SS - Standard Class%' THEN 'Letter Size - BW SS - SC Generic'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - BW DS - Standard Class%' THEN 'Letter Size - BW DS - SC Generic'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - CLR SS - Standard Class%' THEN 'Letter Size - CLR SS - SC Generic'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - CLR DS - Standard Class%' THEN 'Letter Size - CLR DS - SC Generic'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - BW SS - Lettermail%' THEN 'Letter Size - BW SS - Lettermail'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - BW DS - Lettermail%' THEN 'Letter Size - BW DS - Lettermail'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - CLR SS - Lettermail%' THEN 'Letter Size - CLR SS - Lettermail'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - CLR DS - Lettermail%' THEN 'Letter Size - CLR DS - Lettermail'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - BW SS - Personalized%' THEN 'Letter Size - BW SS - Personalized'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - BW DS - Personalized%' THEN 'Letter Size - BW DS - Personalized'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - CLR SS - Personalized%' THEN 'Letter Size - CLR SS - Personalized'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%Letter Size - CLR DS - Personalized%' THEN 'Letter Size - CLR DS - Personalized'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%A4 Size - BW SS - First Class%' THEN 'A4 Size - BW SS - FC Generic'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%A4 Size - BW DS - First Class%' THEN 'A4 Size - BW DS - FC Generic'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%A4 Size - CLR SS - First Class%' THEN 'A4 Size - CLR SS - FC Generic'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%A4 Size - CLR DS - First Class%' THEN 'A4 Size - CLR DS - FC Generic'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%A4 Size - BW SS - Second Class%' THEN 'A4 Size - BW SS - SC Generic'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%A4 Size - BW DS - Second Class%' THEN 'A4 Size - BW DS - SC Generic'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%A4 Size - CLR SS - Second Class%' THEN 'A4 Size - CLR SS - SC Generic'\nWHEN filtered_category_tree_query.\"OrderDetails\" LIKE '%A4 Size - CLR DS - Second Class%' THEN 'A4 Size - CLR DS - SC Generic'\nELSE filtered_category_tree_query.\"OrderDetails\"\nEND AS \"GroupDetails\",\n SUM(customer_line_items_query.\"Qty\") AS \"QtyTotal\",\n    customer_line_items_query.\"CustomerName\",\n    customer_line_items_query.\"Qty\",\n\tcustomer_line_items_query.\"Id\",\n    printer_line_items_query.\"OrderDetailsPrinter\",\n    printer_line_items_query.\"PSummary\",\n    customer_line_items_query.\"Destination\"\n  FROM\n    customer_line_items_query\n    JOIN filtered_category_tree_query ON customer_line_items_query.\"Id\" = filtered_category_tree_query.\"Id\"\n    JOIN printer_line_items_query ON customer_line_items_query.\"Id\" = printer_line_items_query.\"Id\"\n  WHERE\n    customer_line_items_query.\"Printer\" = '{{Select3.selectedOptionLabel}}'\n  GROUP BY\n    \"GroupDetails\",\n    customer_line_items_query.\"CustomerName\",\n    customer_line_items_query.\"Qty\",\n\tcustomer_line_items_query.\"Id\",\n    printer_line_items_query.\"OrderDetailsPrinter\",\n    printer_line_items_query.\"PSummary\",\n    customer_line_items_query.\"Destination\"\n)\n\nSELECT\n  CASE\n    WHEN ROW_NUMBER() OVER (PARTITION BY \"GroupDetails\" ORDER BY \"GroupDetails\") = 1 THEN SUM(\"QtyTotal\") OVER (PARTITION BY \"GroupDetails\")\n    ELSE NULL\n  END AS \"OrderCounts\",\n  \"GroupDetails\" AS \"Collaterals\",\n  \"CustomerName\" AS \"Clients\",\n\t\"Id\",\n  \"Qty\" || ' ' || \"OrderDetailsPrinter\" AS \"OrderDetails\",\n\t(\n    WITH RECURSIVE item_tree(\"Id\", \"SubItemID\", \"InvoiceID\", \"Qty\", \"InitialProdDescription\", \"Amount\", \"PrinterPriceID\", \"Rate\", \"Printer\", depth, \"Destination\") AS (\n      SELECT \"Id\", \"SubItemID\", \"InvoiceID\", \"Qty\", \"InitialProdDescription\", \"Amount\", \"PrinterPriceID\", \"Rate\", \"Printer\", 0, \"Destination\"\n      FROM \"public\".\"PrinterLineItems\"\n      WHERE \"SubItemID\" IS NULL\n      UNION ALL\n      SELECT oi.\"Id\", oi.\"SubItemID\", oi.\"InvoiceID\", oi.\"Qty\", oi.\"InitialProdDescription\", oi.\"Amount\", oi.\"PrinterPriceID\", oi.\"Rate\", oi.\"Printer\", depth + 1, oi.\"Destination\"\n      FROM \"public\".\"PrinterLineItems\" oi\n      JOIN item_tree t ON oi.\"SubItemID\" = t.\"Id\"\n    ),\n    itemsubitems AS (\n      SELECT * FROM item_tree tt\n      WHERE \"Id\" = grouped_query.\"Id\" OR \"SubItemID\" = grouped_query.\"Id\"\n      ORDER BY COALESCE(tt.\"SubItemID\", tt.\"Id\"), tt.\"Id\"\n    )\n    SELECT \n      CASE \n\t\tWHEN COUNT(*) = 1   THEN (\n          SELECT \"Qty\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n        ) || ' * (' || (\n          SELECT \"Rate\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n        )  || ') = ' || (\n          SELECT SUM(\"Amount\") FROM itemsubitems\n        )\n\t\tWHEN COUNT(*) <= 2 AND EXISTS (SELECT 1 FROM itemsubitems WHERE \"InitialProdDescription\" NOT LIKE '%Extra%' OR \"InitialProdDescription\" NOT LIKE '%add%') THEN (\n          SELECT \"Qty\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n        ) || ' * (' || (\n          SELECT \"Rate\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n        ) || ')' || (\n          SELECT STRING_AGG(' + ' || \"Rate\", '') FROM itemsubitems WHERE \"SubItemID\" IS NOT NULL \n        ) || ' = ' || (\n          SELECT SUM(\"Amount\") FROM itemsubitems\n        )\t\t\t\t  \n\t\tWHEN COUNT(*) <= 3 THEN (\n          SELECT \"Qty\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n        ) || ' * (' || (\n          SELECT \"Rate\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n        ) || ' + (' || (\n          SELECT \"Rate\" FROM itemsubitems WHERE \"InitialProdDescription\" LIKE '%Extra%' OR \"InitialProdDescription\" LIKE '%add%' LIMIT 1\n        ) || ' * ' || (\n          ((SELECT \"Qty\" FROM itemsubitems WHERE \"InitialProdDescription\" LIKE '%Extra%' OR \"InitialProdDescription\" LIKE '%add%' LIMIT 1) / (SELECT \"Qty\" FROM itemsubitems WHERE \"SubItemID\" IS NULL))\n        ) || ')' || (\n\t\t\t\t\t  SELECT STRING_AGG(' + ' || \"Rate\", '') FROM (SELECT \"Rate\" FROM  itemsubitems WHERE  \"InitialProdDescription\"\tNOT ILIKE  '%Extra%' AND \"InitialProdDescription\"\tNOT ILIKE  '%add%' OFFSET 1) as sub\n        ) || ') = ' || (\n          SELECT SUM(\"Amount\") FROM itemsubitems\n        )\n      ELSE (\n          SELECT \"Qty\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n        ) || ' * (' || (\n          SELECT \"Rate\" FROM itemsubitems WHERE \"SubItemID\" IS NULL\n        ) || ' + (' || (\n          SELECT \"Rate\" FROM itemsubitems WHERE \"InitialProdDescription\" LIKE '%Extra%' OR \"InitialProdDescription\" LIKE '%add%' LIMIT 1\n        ) || ' * ' || (\n          ((SELECT \"Qty\" FROM itemsubitems WHERE \"InitialProdDescription\" LIKE '%Extra%' OR \"InitialProdDescription\" LIKE '%add%' LIMIT 1) / (SELECT \"Qty\" FROM itemsubitems WHERE \"SubItemID\" IS NULL))\n        ) || ')' || (\t\n\t\t\t\t\t  SELECT STRING_AGG(' + ' || \"Rate\", '') FROM (SELECT \"Rate\" FROM  itemsubitems WHERE  \"InitialProdDescription\"\tNOT ILIKE  '%Extra%' AND \"InitialProdDescription\"\tNOT ILIKE  '%add%' AND \"InitialProdDescription\"\tNOT ILIKE  '%Envelope%'  OFFSET 1) as sub\n        ) || ') = ' || (\n          SELECT SUM(\"Amount\") FROM itemsubitems\n        )\n      END AS formula \n    FROM itemsubitems\n  ) AS result,\n  \"PSummary\" AS \"Subtotal\",\n  \"Destination\" AS \"To\"\nFROM\n  grouped_query\nORDER BY\n  \"GroupDetails\" ASC;",
      "selfReferencingDataPaths": [],
      "pluginSpecifiedTemplates": [
        {
          "value": false
        }
      ]
    },
    "executeOnLoad": true,
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "isValid": true,
    "invalids": [],
    "messages": [],
    "jsonPathKeys": [
      "Select3.selectedOptionLabel",
      "moment(DatePicker1.selectedDate).format('YYYY-MM-DD')"
    ],
    "userSetOnLoad": false,
    "confirmBeforeExecute": false,
    "policies": [],
    "userPermissions": []
  },
  "id": "OrderEmailDrafting_get_draftorders",
  "deleted": false,
  "gitSyncId": "63b393c7f276cd0745e9510c_645c06ccda60c6288bd79510"
}