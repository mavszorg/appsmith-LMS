{
  "pluginType": "DB",
  "pluginId": "postgres-plugin",
  "unpublishedAction": {
    "name": "get_draft_orders_IMS",
    "datasource": {
      "name": "Logistics_db",
      "pluginId": "postgres-plugin",
      "messages": [],
      "isAutoGenerated": false,
      "id": "Logistics_db",
      "deleted": false,
      "policies": [],
      "userPermissions": []
    },
    "pageId": "OrderEmailDrafting",
    "actionConfiguration": {
      "timeoutInMillisecond": 10000,
      "paginationType": "NONE",
      "encodeParamsToggle": true,
      "body": "WITH customer_line_items_query AS (\n  SELECT\n    c1.\"CustomerName\",\n    c3.\"Id\",\n    c3.\"InvoiceID\",\n    c3.\"CustomerPriceID\",\n    c3.\"Qty\",\n    c3.\"Rate\",\n    c3.\"Amount\",\n    c3.\"SubItemID\",\n    c3.\"Printer\",\n    c3.\"OrderStatus\",\n    c3.\"Notes\",\n    c3.\"Destination\",\n    i.\"InvoiceDate\",\n    i.\"PaymentMethod\",\n    i.\"InvoiceStatus\",\n    i.\"OrderStatus\" AS \"InvoiceOrderStatus\"\n  FROM\n    \"public\".\"Customers\" c1\n    INNER JOIN \"public\".\"CustomerPrice\" c2 ON (c2.\"CustomerID\" = c1.\"Id\")\n    INNER JOIN \"public\".\"CustomerLineItems\" c3 ON (c3.\"CustomerPriceID\" = c2.\"Id\")\n    INNER JOIN \"public\".\"Invoice\" i ON (i.\"InvoiceID\" = c3.\"InvoiceID\")\n  WHERE\n    EXISTS (\n      SELECT p.\"ProductDescription\"\n      FROM \"public\".\"Products\" p\n      WHERE p.\"Id\" = c2.\"ProductID\"\n    )\n    AND \"SubItemID\" IS NULL\n    AND to_date(cast(i.\"InvoiceDate\" as TEXT), 'YYYY-MM-DD') >= '{{moment().format('YYYY-MM-DD')}}'\n    AND to_date(cast(i.\"InvoiceDate\" as TEXT), 'YYYY-MM-DD') <= '{{moment().format('YYYY-MM-DD')}}'\n),\ncategory_tree_query AS (\n  WITH RECURSIVE category_tree AS (\n    SELECT\n      \"Id\",\n      \"SubItemID\",\n      \"InvoiceID\",\n      \"Qty\",\n      \"CustomerPriceID\",\n      \"Amount\",\n      \"Printer\",\n      \"Destination\"\n    FROM\n      \"CustomerLineItems\"\n    WHERE\n      \"SubItemID\" IS NULL -- start with top-level categories\n    UNION ALL\n    SELECT\n      oi.\"Id\",\n      oi.\"SubItemID\",\n      oi.\"InvoiceID\",\n      oi.\"Qty\",\n      oi.\"CustomerPriceID\",\n      oi.\"Amount\",\n      oi.\"Printer\",\n      oi.\"Destination\"\n    FROM\n      \"CustomerLineItems\" oi\n      JOIN category_tree ct ON oi.\"SubItemID\" = ct.\"Id\"\n  ),\n  total_amount AS (\n    SELECT SUM(\"Amount\") AS total FROM category_tree\n  )\n  SELECT\n    COALESCE(it.\"SubItemID\", it.\"Id\") AS \"Id\",\n    string_agg(p.\"ProductDescription\", ' ➤ ') AS \"OrderDetails\",\n    SUM(it.\"Amount\") AS \"Summary\"\n  FROM\n    category_tree it\n    JOIN \"public\".\"CustomerPrice\" c2 ON (it.\"CustomerPriceID\" = c2.\"Id\")\n    JOIN \"public\".\"Products\" p ON (p.\"Id\" = c2.\"ProductID\")\n  GROUP BY\n    COALESCE(it.\"SubItemID\", it.\"Id\")\n  ORDER BY\n    \"OrderDetails\" ASC\n),\nfiltered_category_tree_query AS (\n  SELECT *\n  FROM category_tree_query\n  -- WHERE \"OrderDetails\" LIKE '%BW SS - First Class%'\n),\nprinter_line_items_query AS (\n  SELECT\n    main_items.\"Id\" AS \"Id\",\n    CONCAT_WS(' ➤ ', main_items.\"InitialProdDescription\", string_agg(sub_items.\"InitialProdDescription\", ' ➤ ')) AS \"OrderDetailsPrinter\",\n    COALESCE(main_items.\"Amount\", 0) + COALESCE(sub_items_total.\"Amount\", 0) AS \"PSummary\"\nFROM\n\"PrinterLineItems\" AS main_items\nLEFT JOIN (\nSELECT \"SubItemID\", SUM(\"Amount\") AS \"Amount\"\nFROM \"PrinterLineItems\"\nWHERE \"SubItemID\" IS NOT NULL\nGROUP BY \"SubItemID\"\n) sub_items_total ON main_items.\"Id\" = sub_items_total.\"SubItemID\"\nLEFT JOIN (\nSELECT \"SubItemID\", SUM(\"Amount\") AS \"Amount\", \"InitialProdDescription\"\nFROM \"PrinterLineItems\"\nWHERE \"SubItemID\" IS NOT NULL\nGROUP BY \"SubItemID\", \"InitialProdDescription\"\n) sub_items ON main_items.\"Id\" = sub_items.\"SubItemID\"\nINNER JOIN \"public\".\"Invoice\" i ON i.\"InvoiceID\" = main_items.\"InvoiceID\"\nINNER JOIN \"Customers\" c1 ON (c1.\"Id\" = i.\"CustomerID\")\nINNER JOIN \"PrinterPrice\" p1 ON (p1.\"Id\" = main_items.\"PrinterPriceID\")\nINNER JOIN \"Products\" p2 ON (p2.\"Id\" = p1.\"ProductID\")\nWHERE\nmain_items.\"SubItemID\" IS NULL\nGROUP BY\nmain_items.\"Id\",\nmain_items.\"InitialProdDescription\",\nsub_items_total.\"Amount\"\nORDER BY\nmain_items.\"Id\" ASC\n),\ngrouped_query AS (\nSELECT\nCASE\nWHEN customer_line_items_query.\"CustomerName\" LIKE '%Glory%' THEN 'BW DS - FC Generic - Credit Glory Inc'\nWHEN customer_line_items_query.\"CustomerName\" LIKE '%Credit Sage LLC%' THEN 'BW DS - FC Generic - Credit Sage LLC Inc'\nWHEN customer_line_items_query.\"CustomerName\" LIKE '%ECA GreenTech%' THEN 'ECA Greentech'\nELSE filtered_category_tree_query.\"OrderDetails\"\nEND AS \"GroupDetails\",\nSUM(customer_line_items_query.\"Qty\") OVER (PARTITION BY customer_line_items_query.\"CustomerName\" ORDER BY customer_line_items_query.\"CustomerName\") AS \"QtyTotal\",\ncustomer_line_items_query.\"CustomerName\",\ncustomer_line_items_query.\"Qty\",\nprinter_line_items_query.\"OrderDetailsPrinter\",\nprinter_line_items_query.\"PSummary\",\ncustomer_line_items_query.\"Destination\"\nFROM\ncustomer_line_items_query\nJOIN filtered_category_tree_query ON customer_line_items_query.\"Id\" = filtered_category_tree_query.\"Id\"\nJOIN printer_line_items_query ON customer_line_items_query.\"Id\" = printer_line_items_query.\"Id\"\nWHERE\ncustomer_line_items_query.\"Printer\" = '{{Select3.selectedOptionLabel}}'\n)\nSELECT\nCASE\nWHEN ROW_NUMBER() OVER (PARTITION BY \"GroupDetails\" ORDER BY \"GroupDetails\") = 1 THEN MAX(\"QtyTotal\") OVER (PARTITION BY \"GroupDetails\" ORDER BY \"GroupDetails\")\nELSE NULL\nEND AS \"OrderCounts\",\n\"GroupDetails\" as \"Collaterals\",\n\"CustomerName\" as \"Clients\",\n\"Qty\" || ' '|| \"OrderDetailsPrinter\" as \"OrderDetails\",\n\"PSummary\" as \"Subtotal\",\n\"Destination\" as \"To\"\nFROM\ngrouped_query\nORDER BY\n\"GroupDetails\" ASC;\n",
      "selfReferencingDataPaths": [],
      "pluginSpecifiedTemplates": [
        {
          "value": false
        }
      ]
    },
    "executeOnLoad": false,
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "isValid": true,
    "invalids": [],
    "messages": [],
    "jsonPathKeys": [
      "Select3.selectedOptionLabel",
      "moment().format('YYYY-MM-DD')"
    ],
    "userSetOnLoad": false,
    "confirmBeforeExecute": false,
    "policies": [],
    "userPermissions": []
  },
  "id": "OrderEmailDrafting_get_draft_orders_IMS",
  "deleted": false,
  "gitSyncId": "63b393c7f276cd0745e9510c_645be5f3da60c6288bd7936d"
}