{
  "pluginType": "DB",
  "pluginId": "postgres-plugin",
  "unpublishedAction": {
    "name": "get_draft_orders",
    "datasource": {
      "name": "Logistics_db",
      "pluginId": "postgres-plugin",
      "messages": [],
      "isAutoGenerated": false,
      "id": "Logistics_db",
      "deleted": false,
      "policies": [],
      "userPermissions": []
    },
    "pageId": "OrderEmailDrafting",
    "actionConfiguration": {
      "timeoutInMillisecond": 10000,
      "paginationType": "NONE",
      "encodeParamsToggle": true,
      "body": "\n\nWITH customer_line_items_query AS (\n  SELECT c1.\"CustomerName\", c3.\"Id\", c3.\"InvoiceID\", c3.\"CustomerPriceID\", c3.\"Qty\", c3.\"Rate\", c3.\"Amount\", c3.\"SubItemID\", c3.\"Printer\", c3.\"OrderStatus\", c3.\"Notes\", c3.\"Destination\", i.\"InvoiceDate\", i.\"PaymentMethod\", i.\"InvoiceStatus\", i.\"OrderStatus\" as \"InvoiceOrderStatus\"\n  FROM \"public\".\"Customers\" c1 \n    INNER JOIN \"public\".\"CustomerPrice\" c2 ON ( c2.\"CustomerID\" = c1.\"Id\"  )  \n    INNER JOIN \"public\".\"CustomerLineItems\" c3 ON ( c3.\"CustomerPriceID\" = c2.\"Id\"  )  \n    INNER JOIN \"public\".\"Invoice\" i ON ( i.\"InvoiceID\" = c3.\"InvoiceID\"  )  \n  WHERE  EXISTS ( \n    SELECT p.\"ProductDescription\"\n    FROM \"public\".\"Products\" p \n    WHERE p.\"Id\" = c2.\"ProductID\"  ) \n    AND \"SubItemID\" IS NULL \n    AND to_date(cast(i.\"InvoiceDate\" as TEXT),'YYYY-MM-DD') >= '{{moment().format(\"YYYY-MM-DD\")}}'\n    AND to_date(cast(i.\"InvoiceDate\" as TEXT),'YYYY-MM-DD') <= '{{moment().format(\"YYYY-MM-DD\")}}'\n), category_tree_query AS (\n  WITH RECURSIVE category_tree AS (\n    SELECT \"Id\", \"SubItemID\", \"InvoiceID\", \"Qty\", \"CustomerPriceID\", \"Amount\", \"Printer\", \"Destination\"\n    FROM \"CustomerLineItems\"\n    WHERE \"SubItemID\" IS NULL -- start with top-level categories\n    UNION ALL\n    SELECT oi.\"Id\", oi.\"SubItemID\", oi.\"InvoiceID\", oi.\"Qty\", oi.\"CustomerPriceID\", oi.\"Amount\", oi.\"Printer\", oi.\"Destination\"\n    FROM \"CustomerLineItems\" oi\n    JOIN category_tree ct ON oi.\"SubItemID\" = ct.\"Id\"\n  ), total_amount AS (\n    SELECT SUM(\"Amount\") AS total FROM category_tree\n  )\n  SELECT\n    COALESCE(it.\"SubItemID\", it.\"Id\") as \"Id\",\n    string_agg(p.\"ProductDescription\", ' ➤ ') as \"OrderDetails\",\n    SUM(it.\"Amount\") as \"Summary\"\n  FROM category_tree it\n  JOIN \"public\".\"CustomerPrice\" c2 ON (it.\"CustomerPriceID\" = c2.\"Id\")\n  JOIN \"public\".\"Products\" p ON (p.\"Id\" = c2.\"ProductID\")\n  GROUP BY COALESCE(it.\"SubItemID\", it.\"Id\")\n  ORDER BY \"Id\"\n), printer_line_items_query AS (\n  SELECT\n    main_items.\"Id\" AS \"Id\",\n    CONCAT_WS(' ➤ ', main_items.\"InitialProdDescription\", string_agg(sub_items.\"InitialProdDescription\", ' ➤ ')) AS \"OrderDetailsPrinter\",\n    COALESCE(main_items.\"Amount\", 0) + COALESCE(sub_items_total.\"Amount\", 0) AS \"PSummary\"\n  FROM\n    \"PrinterLineItems\" AS main_items\n    LEFT JOIN (\n      SELECT \"SubItemID\", SUM(\"Amount\") AS \"Amount\"\n      FROM \"PrinterLineItems\"\n      WHERE \"SubItemID\" IS NOT NULL\n      GROUP BY \"SubItemID\"\n    ) sub_items_total ON main_items.\"Id\" = sub_items_total.\"SubItemID\"\n    LEFT JOIN (\n      SELECT \"SubItemID\", SUM(\"Amount\") AS \"Amount\", \"InitialProdDescription\"\n      FROM \"PrinterLineItems\"\n      WHERE \"SubItemID\" IS NOT NULL\n      GROUP BY \"SubItemID\", \"InitialProdDescription\"\n    ) sub_items ON main_items.\"Id\" = sub_items.\"SubItemID\"\n    INNER JOIN \"public\".\"Invoice\" i ON i.\"InvoiceID\" = main_items.\"InvoiceID\" \n    INNER JOIN \"Customers\" c1 ON ( c1.\"Id\" = i.\"CustomerID\"  )  \n    INNER JOIN \"PrinterPrice\" p1 ON ( p1.\"Id\" = main_items.\"PrinterPriceID\"  )  \n    INNER JOIN \"Products\" p2 ON ( p2.\"Id\" = p1.\"ProductID\"  )\n  WHERE main_items.\"SubItemID\" IS NULL \n  GROUP BY\n    main_items.\"Id\",\n    main_items.\"InitialProdDescription\",\n    sub_items_total.\"Amount\"\n  ORDER BY main_items.\"Id\" ASC\n)\nSELECT *\nFROM customer_line_items_query\nJOIN category_tree_query ON customer_line_items_query.\"Id\" = category_tree_query.\"Id\"\nJOIN printer_line_items_query ON customer_line_items_query.\"Id\" = printer_line_items_query.\"Id\"\nORDER BY customer_line_items_query.\"Id\" ASC;\n\n",
      "selfReferencingDataPaths": [],
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ]
    },
    "executeOnLoad": false,
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "isValid": true,
    "invalids": [],
    "messages": [],
    "jsonPathKeys": [
      "moment().format(\"YYYY-MM-DD\")"
    ],
    "userSetOnLoad": false,
    "confirmBeforeExecute": false,
    "policies": [],
    "userPermissions": []
  },
  "id": "OrderEmailDrafting_get_draft_orders",
  "deleted": false,
  "gitSyncId": "63b393c7f276cd0745e9510c_645be5f3da60c6288bd7936d"
}