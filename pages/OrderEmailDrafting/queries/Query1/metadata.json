{
  "pluginType": "DB",
  "pluginId": "postgres-plugin",
  "unpublishedAction": {
    "name": "Query1",
    "datasource": {
      "name": "Logistics_db",
      "pluginId": "postgres-plugin",
      "messages": [],
      "isAutoGenerated": false,
      "id": "Logistics_db",
      "deleted": false,
      "policies": [],
      "userPermissions": []
    },
    "pageId": "OrderEmailDrafting",
    "actionConfiguration": {
      "timeoutInMillisecond": 10000,
      "paginationType": "NONE",
      "encodeParamsToggle": true,
      "body": "\n\nWITH customer_line_items_query AS (\nSELECT\nc1.\"CustomerName\",\nc3.\"Id\",\nc3.\"InvoiceID\",\nc3.\"CustomerPriceID\",\nc3.\"Qty\",\nc3.\"Rate\",\nc3.\"Amount\",\nc3.\"SubItemID\",\nc3.\"Printer\",\nc3.\"OrderStatus\",\nc3.\"Notes\",\nc3.\"Destination\",\ni.\"InvoiceDate\",\ni.\"PaymentMethod\",\ni.\"InvoiceStatus\",\ni.\"OrderStatus\" as \"InvoiceOrderStatus\"\nFROM \"public\".\"Customers\" c1\nINNER JOIN \"public\".\"CustomerPrice\" c2 ON ( c2.\"CustomerID\" = c1.\"Id\" )\nINNER JOIN \"public\".\"CustomerLineItems\" c3 ON ( c3.\"CustomerPriceID\" = c2.\"Id\" )\nINNER JOIN \"public\".\"Invoice\" i ON ( i.\"InvoiceID\" = c3.\"InvoiceID\" )\nWHERE EXISTS (\nSELECT p.\"ProductDescription\"\nFROM \"public\".\"Products\" p\nWHERE p.\"Id\" = c2.\"ProductID\" )\nAND \"SubItemID\" IS NULL\nAND to_date(cast(i.\"InvoiceDate\" as TEXT),'YYYY-MM-DD') >= '2023-05-09'\nAND to_date(cast(i.\"InvoiceDate\" as TEXT),'YYYY-MM-DD') <= '2023-05-09'\n),\ncategory_tree_query AS (\nWITH RECURSIVE category_tree AS (\nSELECT\n\"Id\",\n\"SubItemID\",\n\"InvoiceID\",\n\"Qty\",\n\"CustomerPriceID\",\n\"Amount\",\n\"Printer\",\n\"Destination\"\nFROM \"CustomerLineItems\"\nWHERE \"SubItemID\" IS NULL -- start with top-level categories\nUNION ALL\nSELECT\noi.\"Id\",\noi.\"SubItemID\",\noi.\"InvoiceID\",\noi.\"Qty\",\noi.\"CustomerPriceID\",\noi.\"Amount\",\noi.\"Printer\",\noi.\"Destination\"\nFROM \"CustomerLineItems\" oi\nJOIN category_tree ct ON oi.\"SubItemID\" = ct.\"Id\"\n),\ntotal_amount AS (\nSELECT SUM(\"Amount\") AS total FROM category_tree\n)\nSELECT\nCOALESCE(it.\"SubItemID\", it.\"Id\") as \"Id\",\nstring_agg(p.\"ProductDescription\", ' ➤ ') as \"OrderDetails\",\nSUM(it.\"Amount\") as \"Summary\"\nFROM category_tree it\nJOIN \"public\".\"CustomerPrice\" c2 ON (it.\"CustomerPriceID\" = c2.\"Id\")\nJOIN \"public\".\"Products\" p ON (p.\"Id\" = c2.\"ProductID\")\nGROUP BY COALESCE(it.\"SubItemID\", it.\"Id\")\nORDER BY \"OrderDetails\" ASC\n),\nfiltered_category_tree_query AS (\nSELECT *\nFROM category_tree_query\n--WHERE \"OrderDetails\" LIKE '%BW SS - First Class%'\n),\nprinter_line_items_query AS (\nSELECT\nmain_items.\"Id\" AS \"Id\",\nCONCAT_WS(' ➤ ', main_items.\"InitialProdDescription\", string_agg(sub_items.\"InitialProdDescription\", ' ➤ ')) AS \"OrderDetailsPrinter\",\nCOALESCE(main_items.\"Amount\", 0) + COALESCE(sub_items_total.\"Amount\", 0) AS \"PSummary\"\nFROM\n\"PrinterLineItems\" AS main_items\nLEFT JOIN (\nSELECT \"SubItemID\", SUM(\"Amount\") AS \"Amount\"\nFROM \"PrinterLineItems\"\nWHERE \"SubItemID\" IS NOT NULL\nGROUP BY \"SubItemID\"\n) sub_items_total ON main_items.\"Id\" = sub_items_total.\"SubItemID\"\nLEFT JOIN (\nSELECT \"SubItemID\", SUM(\"Amount\") AS \"Amount\", \"InitialProdDescription\"\nFROM \"PrinterLineItems\"\nWHERE \"SubItemID\" IS NOT NULL\nGROUP BY \"SubItemID\", \"InitialProdDescription\"\n) sub_items ON main_items.\"Id\" = sub_items.\"SubItemID\"\nINNER JOIN \"public\".\"Invoice\" i ON i.\"InvoiceID\" = main_items.\"InvoiceID\"\nINNER JOIN \"Customers\" c1 ON ( c1.\"Id\" = i.\"CustomerID\" )\nINNER JOIN \"PrinterPrice\" p1 ON ( p1.\"Id\" = main_items.\"PrinterPriceID\" )\nINNER JOIN \"Products\" p2 ON ( p2.\"Id\" = p1.\"ProductID\" )\nWHERE main_items.\"SubItemID\" IS NULL\nGROUP BY\nmain_items.\"Id\",\nmain_items.\"InitialProdDescription\",\nsub_items_total.\"Amount\"\nORDER BY main_items.\"Id\" ASC\n)\nSELECT\ncustomer_line_items_query.\"CustomerName\",\nfiltered_category_tree_query.\"OrderDetails\",\ncustomer_line_items_query.\"Id\",\ncustomer_line_items_query.\"InvoiceID\",\ncustomer_line_items_query.\"CustomerPriceID\",\ncustomer_line_items_query.\"Qty\",\ncustomer_line_items_query.\"Rate\",\ncustomer_line_items_query.\"Amount\",\ncustomer_line_items_query.\"SubItemID\",\ncustomer_line_items_query.\"Printer\",\ncustomer_line_items_query.\"OrderStatus\",\ncustomer_line_items_query.\"Notes\",\ncustomer_line_items_query.\"Destination\",\ncustomer_line_items_query.\"InvoiceDate\",\ncustomer_line_items_query.\"PaymentMethod\",\ncustomer_line_items_query.\"InvoiceStatus\",\ncustomer_line_items_query.\"InvoiceOrderStatus\",\nfiltered_category_tree_query.\"Summary\",\nprinter_line_items_query.\"PSummary\",\nSUM(customer_line_items_query.\"Qty\") OVER (PARTITION BY filtered_category_tree_query.\"OrderDetails\" ORDER BY filtered_category_tree_query.\"OrderDetails\") AS \"QtyTotal\"\nFROM customer_line_items_query\nJOIN filtered_category_tree_query ON customer_line_items_query.\"Id\" = filtered_category_tree_query.\"Id\"\nJOIN printer_line_items_query ON customer_line_items_query.\"Id\" = printer_line_items_query.\"Id\"\nWHERE customer_line_items_query.\"Printer\" = 'SolutionsInMail'\nORDER BY filtered_category_tree_query.\"OrderDetails\" ASC;\n",
      "selfReferencingDataPaths": [],
      "pluginSpecifiedTemplates": [
        {
          "value": false
        }
      ]
    },
    "executeOnLoad": true,
    "dynamicBindingPathList": [],
    "isValid": true,
    "invalids": [],
    "messages": [],
    "jsonPathKeys": [],
    "userSetOnLoad": false,
    "confirmBeforeExecute": false,
    "policies": [],
    "userPermissions": []
  },
  "id": "OrderEmailDrafting_Query1",
  "deleted": false,
  "gitSyncId": "63b393c7f276cd0745e9510c_645c06ccda60c6288bd79510"
}